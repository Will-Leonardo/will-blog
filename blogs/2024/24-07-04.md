## VueUse源码解读 - createGlobalState

> 用于创建全局状态，可以在跨组件实例中非常有用，你可以在A组件和B组件之间共享状态。典型的应用场景就是购物车，比如我们通常需要在所有的页面显示购物车内商品的数量，这时你可以使用全局状态来实现，就是简化版的pinia。

## 使用案例

```ts
import { computed, ref } from 'vue'
import { createGlobalState } from '@vueuse/core'

export const useGlobalState = createGlobalState(
  () => {
    // state
    const count = ref(0)

    // getters
    const doubleCount = computed(() => count.value * 2)

    // actions
    function increment() {
      count.value++
    }

    return { count, doubleCount, increment }
  }
)
```

```vue
<template>
  <div>
   <p>A组件</p>
    <button @click="state.increment">点击+</button>
     <pre>状态属性：{{ state.count }}</pre>
     <pre>计算属性：{{ state.doubleCount }}</pre>
   </div>
 </template>

 <script setup lang="ts">
 import { computed, onMounted, reactive } from 'vue';
 import { useGlobalState }  from './useGlobalState';
 
 const state = useGlobalState();

 </script>
```

## 源码解读

核心点在于`Vue3.2+`提供的新api `effectScope`;

> 

```ts
export function createGlobalState<Fn extends AnyFn>(
  stateFactory: Fn,
): Fn {
  let initialized = false
  let state: any
  const scope = effectScope(true)

  return ((...args: any[]) => {
    if (!initialized) {
      state = scope.run(() => stateFactory(...args))!
      initialized = true
    }
    return state
  }) as Fn
}
```