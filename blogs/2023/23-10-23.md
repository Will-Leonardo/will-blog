---
title: Vue自定义指令
date: 2023-10-23
categories: 
 - 日常笔记
---
<Boxx type='tip' />

最近在做需求的时候有个复制文案的功能被重复使用，思考着可以使用vue的自定义指令，这样才能更好的复用代码。
话不多说，先介绍一下自定义指令。 [官方文档传送门](https://cn.vuejs.org/guide/reusability/custom-directives.html)

> 我们已经介绍了两种在 Vue 中重用代码的方式：组件和组合式函数。组件是主要的构建模块，而组合式函数则侧重于有状态的逻辑。另一方面，自定义指令主要是为了重用涉及普通元素的底层 DOM 访问的逻辑。

## 什么是指令？

在Vue中，指令（Directive）是一种**特殊的属性**，用于给HTML元素添加特定的行为或功能。指令以v-开头，后面跟着指令的名称，例如v-bind、v-if、v-for等（这些是内置指令）。指令可以用于控制**元素的显示、隐藏、绑定属性、循环渲染等**操作。通过指令，我们可以在模板中直接操作数据和DOM，使得开发更加灵活和高效。

## 具体场景

- 自动聚焦：可以创建一个自定义指令，在元素插入到DOM后自动将焦点设置到该元素上。

- 懒加载：可以创建一个自定义指令，在图片或其他资源进入可视区域时才加载，以提升页面加载性能。

- 滚动加载：可以创建一个自定义指令，在滚动到指定位置时触发加载更多数据的操作。

- 防抖和节流：可以创建自定义指令来实现防抖和节流的效果，以避免频繁触发事件。

- 拖拽：可以创建一个自定义指令，使元素可以通过鼠标或触摸事件进行拖拽操作。

- 格式化输入：可以创建一个自定义指令，限制输入框只能输入特定格式的内容，如数字、日期等。

- 按钮权限控制：可以创建一个自定义指令，根据用户的权限动态控制按钮的显示或禁用状态。

- 图片预览：可以创建一个自定义指令，使图片在点击或悬停时以弹窗或其他方式进行预览。

- 复制文案：将要复制的文案传递给指令，当按钮被点击时，指令会将文案复制到剪贴板中。


## 实现

```js
import { DirectiveBinding } from "vue";
import { ElMessage } from "element-plus";

interface CopyHTMLElement<T> extends HTMLElement {
  _copyTextHandler: (text: T) => void;
  copyText: string;
}

const writeText = (text: string) => {
  if (!text) {
    console.error("复制文本失败:");
    return;
  }
  navigator.clipboard
    .writeText(text)
    .then(() => {
      console.log("文本已复制");
      ElMessage({
        message: `复制成功：${text}`,
        type: "success",
      });
    })
    .catch((error) => {
      console.error("复制文本失败:", error);
    });
};

const copyText = {
  mounted(el: CopyHTMLElement<MouseEvent | string>, binding: DirectiveBinding) {
    if (binding.value) {
      Object.assign(el, { copyText: binding.value });
    }

    el._copyTextHandler = () => writeText(el.copyText);
    el.addEventListener("click", el._copyTextHandler);
  },

  updated(el: CopyHTMLElement<string>, binding: DirectiveBinding) {
    Object.assign(el, { copyText: binding.value });
  },

  unmounted(el: CopyHTMLElement<MouseEvent>) {
    el.removeEventListener("click", el._copyTextHandler);
  },
};

export default copyText;
```

```js
import { App, Directive } from "vue";
import AutoFocus from "./autoFocus";
import CopyText from "./copyText";

const directivesList: Record<string, Directive> = {
  AutoFocus,
  CopyText,
};

export default {
  install(app: App) {
    for (const [key, directive] of Object.entries(directivesList)) {
      app.directive(key, directive);
    }
  },
};
```


```ts
import directives from "@/directives";
const app = createApp(App);

app.use(directives).use(router).use(ElementPlus).mount("#app");
```

## 在组件上使用

不推荐在组件上使用自定义指令。当组件具有多个根节点时可能会出现预期外的行为。

当在组件上使用自定义指令时，它会始终应用于组件的根节点，和透传 attributes 类似。

```vue
<template>
<MyComponent v-demo="test" />
</template>
<!-- MyComponent 的模板 -->

<div> <!-- v-demo 指令会被应用在此处 -->
  <span>My component content</span>
</div>
```

需要注意的是组件可能含有多个根节点。当应用到一个多根组件时，指令将会被忽略且抛出一个警告。和 attribute 不同，指令不能通过 v-bind="$attrs" 来传递给一个不同的元素。